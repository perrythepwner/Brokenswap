{"ast":null,"code":"import _objectSpread from\"/home/simone/Scrivania/progetti/HTB_challs/HackTheBoo_23/VeryEasy2/Brokenswap/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/home/simone/Scrivania/progetti/HTB_challs/HackTheBoo_23/VeryEasy2/Brokenswap/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _taggedTemplateLiteral from\"/home/simone/Scrivania/progetti/HTB_challs/HackTheBoo_23/VeryEasy2/Brokenswap/frontend/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject,_templateObject2;import{Contract}from'@ethersproject/contracts';import{formatUnits}from'@ethersproject/units';import{ERC20_ABI}from'constants/abis/erc20';import{ethers}from'ethers';import React,{useCallback,useContext,useState}from'react';import{ArrowDown}from'react-feather';import{Text}from'rebass';import styled,{ThemeContext}from'styled-components';import AddressInputPanel from'../../components/AddressInputPanel';import{ButtonPrimary}from'../../components/Button';import{AutoColumn}from'../../components/Column';import CurrencyInputPanel from'../../components/CurrencyInputPanel';import Modal from'../../components/Modal';import{SwapPoolTabs}from'../../components/NavigationTabs';import{AutoRow,RowBetween}from'../../components/Row';import{ArrowWrapper,Wrapper}from'../../components/swap/styleds';import SwapHeader from'../../components/swap/SwapHeader';import BROKENSWAP_ABI from'../../constants/abis/Brokenswap.json';import{useConnectionInfo}from'../../hooks/useConnectionInfo';import{useWeb3Provider}from'../../hooks/useContract';import{Field}from'../../state/swap/actions';import{useDerivedSwapInfo,useSwapActionHandlers,useSwapState}from'../../state/swap/hooks';import{CloseIcon,LinkStyledButton}from'../../theme';import AppBody from'../AppBody';// to-do: move to /abis/\nimport{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const ContentWrapper=styled(AutoColumn)(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  width: 100%;\\n  flex: 1 1;\\n  position: relative;\\n  padding: 1rem;\\n\"])));const Label=styled.span(_templateObject2||(_templateObject2=_taggedTemplateLiteral([\"\\n  font-weight: bold;\\n  margin-bottom: 0.5rem;\\n\"])));const InfoLabel=_ref=>{let{label,value}=_ref;return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(Label,{children:[label,\": \"]}),value]});};export default function Swap(){var _parsedAmounts$depend,_parsedAmounts$depend2,_currencies$Field$INP,_currencies$Field$INP2,_currencies$Field$OUT,_currencies$Field$OUT2,_currencies$Field$INP3,_currencies$Field$INP4,_currencies$Field$INP5;const theme=useContext(ThemeContext);const{independentField,typedValue,recipient}=useSwapState();const{parsedAmount,currencies}=useDerivedSwapInfo();const parsedAmounts={[Field.INPUT]:parsedAmount,[Field.OUTPUT]:parsedAmount};const{onSwitchTokens,onCurrencySelection,onUserInput,onChangeRecipient}=useSwapActionHandlers();const dependentField=independentField===Field.INPUT?Field.OUTPUT:Field.INPUT;const handleTypeInput=useCallback(value=>{onUserInput(Field.INPUT,value);},[onUserInput]);const handleTypeOutput=useCallback(value=>{onUserInput(Field.OUTPUT,value);},[onUserInput]);const formattedAmounts={[independentField]:typedValue,[dependentField]:(_parsedAmounts$depend=(_parsedAmounts$depend2=parsedAmounts[dependentField])===null||_parsedAmounts$depend2===void 0?void 0:_parsedAmounts$depend2.toSignificant(6))!==null&&_parsedAmounts$depend!==void 0?_parsedAmounts$depend:''};const handleInputSelect=useCallback(inputCurrency=>{onCurrencySelection(Field.INPUT,inputCurrency);},[onCurrencySelection]);const handleOutputSelect=useCallback(outputCurrency=>onCurrencySelection(Field.OUTPUT,outputCurrency),[onCurrencySelection]);const[showPopup,setShowPopup]=useState(false);const[showTxPopup,setShowTxPopup]=useState(false);const[transactionInfo,setTransactionInfo]=useState({title:'',txHash:'',logs:[],errorCode:'',errorMessage:'',errorBody:'',revertReason:''});const[connectionInfo,isInstanceRunning]=useConnectionInfo();const provider=useWeb3Provider();function sendSwap(_x,_x2,_x3){return _sendSwap.apply(this,arguments);}function _sendSwap(){_sendSwap=_asyncToGenerator(function*(inputToken,outputToken,inputAmount){if(inputToken===undefined||outputToken===undefined){setTransactionInfo({title:'SWAP FAILED',txHash:'',logs:[],errorCode:'',errorMessage:'Select input and output tokens first',errorBody:'',revertReason:''});}else{if(isInstanceRunning&&provider){try{console.log('===========INITIALIZING SWAP===========','inputToken',inputToken,'outputToken',outputToken,'inputAmount',inputAmount);const BROKENSWAP_ADDRESS=connectionInfo['Target Contract'];const signer=new ethers.Wallet(connectionInfo['Player Private Key'],provider);// approve transfer first\nconst inputTokenContract=new Contract(inputToken.address,ERC20_ABI,signer);const approval=yield inputTokenContract.approve(BROKENSWAP_ADDRESS,ethers.utils.parseUnits(inputAmount,18));const approvalRcpt=yield approval.wait();const Brokenswap=new Contract(BROKENSWAP_ADDRESS,BROKENSWAP_ABI.abi,signer);const transaction=yield Brokenswap.swap(inputToken.address,outputToken.address,ethers.utils.parseUnits(inputAmount,18));const TxRcpt=yield transaction.wait();const currentBlock=yield provider.getBlockNumber();const events=yield Brokenswap.queryFilter('Swap',currentBlock,currentBlock);console.log('===========SWAP SUCCESSFUL===========','Transaction Receipt',TxRcpt);setTransactionInfo({title:'SWAP SUCCESSFUL',txHash:TxRcpt.transactionHash,logs:events[0].topics,errorCode:'',errorMessage:'',errorBody:'',revertReason:''});setShowTxPopup(true);}catch(error){console.log('===========SWAP FAILED===========','ERROR',error);setTransactionInfo(prevState=>{var _ref2,_ref3,_error$error$error$bo,_error$error,_error$error$error,_error$error2;return _objectSpread(_objectSpread({},prevState),{},{title:'SWAP FAILED',revertReason:error.reason||undefined,errorCode:error.code||undefined,errorMessage:error.code!=='UNPREDICTABLE_GAS_LIMIT'&&error.code!=='SERVER_ERROR'?error.message:undefined,errorBody:(_ref2=(_ref3=(_error$error$error$bo=(_error$error=error.error)===null||_error$error===void 0?void 0:(_error$error$error=_error$error.error)===null||_error$error$error===void 0?void 0:_error$error$error.body)!==null&&_error$error$error$bo!==void 0?_error$error$error$bo:(_error$error2=error.error)===null||_error$error2===void 0?void 0:_error$error2.body)!==null&&_ref3!==void 0?_ref3:error.body)!==null&&_ref2!==void 0?_ref2:undefined});});setShowTxPopup(true);}}else{setShowPopup(true);}}});return _sendSwap.apply(this,arguments);}return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(SwapPoolTabs,{active:'swap'}),/*#__PURE__*/_jsxs(AppBody,{children:[/*#__PURE__*/_jsx(SwapHeader,{title:'Swap'}),/*#__PURE__*/_jsx(Wrapper,{id:\"swap-page\",children:/*#__PURE__*/_jsxs(AutoColumn,{gap:'md',children:[/*#__PURE__*/_jsx(CurrencyInputPanel,{label:'From',value:formattedAmounts[Field.INPUT],showMaxButton:false,showHalfButton:false,currency:currencies[Field.INPUT],onUserInput:handleTypeInput,onCurrencySelect:handleInputSelect,otherCurrency:currencies[Field.OUTPUT],id:\"swap-currency-input\"}),/*#__PURE__*/_jsx(AutoColumn,{justify:\"space-between\",children:/*#__PURE__*/_jsx(AutoRow,{justify:'center',style:{padding:'0 1rem'},children:/*#__PURE__*/_jsx(ArrowWrapper,{clickable:true,children:/*#__PURE__*/_jsx(ArrowDown,{size:\"16\",onClick:()=>{handleTypeInput(formattedAmounts[Field.OUTPUT]);onSwitchTokens();},color:currencies[Field.INPUT]&&currencies[Field.OUTPUT]?theme.primary1:theme.text2})})})}),/*#__PURE__*/_jsx(CurrencyInputPanel,{value:formattedAmounts[Field.OUTPUT],onUserInput:handleTypeOutput,label:independentField===Field.INPUT?'To':undefined,showMaxButton:false,currency:currencies[Field.OUTPUT],hideNumericalInput:true,onCurrencySelect:handleOutputSelect,otherCurrency:currencies[Field.INPUT],id:\"swap-currency-output\",disabled:true}),recipient!==null?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(AutoRow,{justify:\"space-between\",style:{padding:'0 1rem'},children:[/*#__PURE__*/_jsx(ArrowWrapper,{clickable:false,children:/*#__PURE__*/_jsx(ArrowDown,{size:\"16\",color:theme.text2})}),/*#__PURE__*/_jsx(LinkStyledButton,{id:\"remove-recipient-button\",onClick:()=>onChangeRecipient(null),children:\"- Remove send\"})]}),/*#__PURE__*/_jsx(AddressInputPanel,{id:\"recipient\",value:recipient,onChange:onChangeRecipient})]}):null,/*#__PURE__*/_jsx(ButtonPrimary,{borderRadius:\"12px\",onClick:()=>sendSwap(currencies[Field.INPUT],currencies[Field.OUTPUT],formattedAmounts[Field.INPUT]),children:'Swap'}),/*#__PURE__*/_jsx(Modal,{isOpen:showPopup,onDismiss:()=>setShowPopup(false),children:/*#__PURE__*/_jsx(ContentWrapper,{children:/*#__PURE__*/_jsx(AutoColumn,{gap:\"12px\",children:/*#__PURE__*/_jsxs(RowBetween,{children:[/*#__PURE__*/_jsx(Text,{fontWeight:500,fontSize:18,children:'No instance found!\\nStart a new instance in the Challenge Handler and then Reload the page.'}),/*#__PURE__*/_jsx(CloseIcon,{onClick:()=>setShowPopup(false)})]})})})}),/*#__PURE__*/_jsx(Modal,{isOpen:showTxPopup,onDismiss:()=>setShowTxPopup(false),children:/*#__PURE__*/_jsx(ContentWrapper,{gap:'12x',children:/*#__PURE__*/_jsxs(AutoColumn,{gap:\"12px\",children:[/*#__PURE__*/_jsxs(RowBetween,{children:[/*#__PURE__*/_jsx(Text,{fontWeight:800,fontSize:18,style:transactionInfo.errorMessage===''?{color:'#8878C3'}:{color:'#E83B46'},children:transactionInfo.title}),/*#__PURE__*/_jsx(CloseIcon,{onClick:()=>setShowTxPopup(false)})]}),/*#__PURE__*/_jsx(RowBetween,{children:/*#__PURE__*/_jsxs(Text,{fontWeight:400,fontSize:18,children:[transactionInfo.txHash&&/*#__PURE__*/_jsx(InfoLabel,{label:\"Transaction Hash\",value:transactionInfo.txHash}),transactionInfo.logs&&transactionInfo.logs.length==4&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(InfoLabel,{label:\"Swap Details\",value:''}),/*#__PURE__*/_jsx(InfoLabel,{label:\"Input\",value:parseFloat(formatUnits(transactionInfo.logs[1],18))+'   '+((_currencies$Field$INP=(_currencies$Field$INP2=currencies[Field.INPUT])===null||_currencies$Field$INP2===void 0?void 0:_currencies$Field$INP2.symbol)!==null&&_currencies$Field$INP!==void 0?_currencies$Field$INP:'')}),/*#__PURE__*/_jsx(InfoLabel,{label:\"Output\",value:parseFloat(formatUnits(transactionInfo.logs[2],18))+'   '+((_currencies$Field$OUT=(_currencies$Field$OUT2=currencies[Field.OUTPUT])===null||_currencies$Field$OUT2===void 0?void 0:_currencies$Field$OUT2.symbol)!==null&&_currencies$Field$OUT!==void 0?_currencies$Field$OUT:'')}),/*#__PURE__*/_jsx(InfoLabel,{label:\"With Amount of Fees moved to Fees Pool\",value:((_currencies$Field$INP3=currencies[Field.INPUT])===null||_currencies$Field$INP3===void 0?void 0:_currencies$Field$INP3.symbol)&&parseFloat(formatUnits(transactionInfo.logs[3],18))+' '+((_currencies$Field$INP4=(_currencies$Field$INP5=currencies[Field.INPUT])===null||_currencies$Field$INP5===void 0?void 0:_currencies$Field$INP5.symbol)!==null&&_currencies$Field$INP4!==void 0?_currencies$Field$INP4:'')}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(InfoLabel,{label:\"NOTE\",value:'\\n Reload page to view updated balances'})]}),transactionInfo.errorCode&&/*#__PURE__*/_jsx(InfoLabel,{label:\"Error code\",value:transactionInfo.errorCode}),transactionInfo.errorMessage&&/*#__PURE__*/_jsx(InfoLabel,{label:\"Error message\",value:transactionInfo.errorMessage}),transactionInfo.errorBody&&/*#__PURE__*/_jsx(InfoLabel,{label:\"Error body\",value:JSON.parse(transactionInfo.errorBody).error.message}),transactionInfo.revertReason&&/*#__PURE__*/_jsx(InfoLabel,{label:\"Revert reason\",value:transactionInfo.revertReason})]})})]})})})]})})]})]});}","map":null,"metadata":{},"sourceType":"module"}