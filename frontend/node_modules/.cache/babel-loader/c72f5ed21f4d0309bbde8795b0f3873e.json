{"ast":null,"code":"import{useCelo,useProvider}from'@celo/react-celo';import{useCallback,useEffect,useState}from'react';import{useDispatch}from'react-redux';import useDebounce from'../../hooks/useDebounce';import useIsWindowVisible from'../../hooks/useIsWindowVisible';import{updateBlockNumber}from'./actions';import{useBlockNumber}from'./hooks';const BLOCK_NUMBER_MINIMUM_DIFF=5;export default function Updater(){const library=useProvider();const{network}=useCelo();const chainId=network.chainId;const dispatch=useDispatch();const blockNumber=useBlockNumber();const windowVisible=useIsWindowVisible();const[state,setState]=useState({chainId,blockNumber:null});const blockNumberCallback=useCallback(blockNumber=>{setState(state=>{if(chainId===state.chainId){if(typeof state.blockNumber!=='number')return{chainId,blockNumber};return{chainId,blockNumber:Math.max(blockNumber,state.blockNumber)};}return state;});},[chainId,setState]);// attach/detach listeners\nuseEffect(()=>{if(!library||!chainId||!windowVisible)return undefined;setState({chainId,blockNumber:null});library.getBlockNumber().then(blockNumberCallback).catch(error=>console.error(\"Failed to get block number for chainId: \".concat(chainId),error));library.on('block',blockNumberCallback);return()=>{library.removeListener('block',blockNumberCallback);};},[dispatch,chainId,library,blockNumberCallback,windowVisible]);const debouncedState=useDebounce(state,100);useEffect(()=>{if(!debouncedState.chainId||!debouncedState.blockNumber||!windowVisible)return;if(debouncedState.blockNumber-(blockNumber||0)<BLOCK_NUMBER_MINIMUM_DIFF)return;dispatch(updateBlockNumber({chainId:debouncedState.chainId,blockNumber:debouncedState.blockNumber}));},[windowVisible,dispatch,debouncedState.blockNumber,debouncedState.chainId,blockNumber]);return null;}","map":{"version":3,"names":["useCelo","useProvider","useCallback","useEffect","useState","useDispatch","useDebounce","useIsWindowVisible","updateBlockNumber","useBlockNumber","BLOCK_NUMBER_MINIMUM_DIFF","Updater","library","network","chainId","dispatch","blockNumber","windowVisible","state","setState","blockNumberCallback","Math","max","undefined","getBlockNumber","then","catch","error","console","concat","on","removeListener","debouncedState"],"sources":["/home/simone/Scrivania/progetti/HTB_challs/HackTheBoo_23/VeryEasy2/Brokenswap/frontend/src/state/application/updater.ts"],"sourcesContent":["import { useCelo, useProvider } from '@celo/react-celo'\nimport { useCallback, useEffect, useState } from 'react'\nimport { useDispatch } from 'react-redux'\n\nimport useDebounce from '../../hooks/useDebounce'\nimport useIsWindowVisible from '../../hooks/useIsWindowVisible'\nimport { updateBlockNumber } from './actions'\nimport { useBlockNumber } from './hooks'\n\nconst BLOCK_NUMBER_MINIMUM_DIFF = 5\n\nexport default function Updater(): null {\n  const library = useProvider()\n  const { network } = useCelo()\n  const chainId = network.chainId\n  const dispatch = useDispatch()\n  const blockNumber = useBlockNumber()\n\n  const windowVisible = useIsWindowVisible()\n\n  const [state, setState] = useState<{ chainId: number | undefined; blockNumber: number | null }>({\n    chainId,\n    blockNumber: null,\n  })\n\n  const blockNumberCallback = useCallback(\n    (blockNumber: number) => {\n      setState((state) => {\n        if (chainId === state.chainId) {\n          if (typeof state.blockNumber !== 'number') return { chainId, blockNumber }\n          return { chainId, blockNumber: Math.max(blockNumber, state.blockNumber) }\n        }\n        return state\n      })\n    },\n    [chainId, setState]\n  )\n\n  // attach/detach listeners\n  useEffect(() => {\n    if (!library || !chainId || !windowVisible) return undefined\n\n    setState({ chainId, blockNumber: null })\n\n    library\n      .getBlockNumber()\n      .then(blockNumberCallback)\n      .catch((error) => console.error(`Failed to get block number for chainId: ${chainId}`, error))\n\n    library.on('block', blockNumberCallback)\n    return () => {\n      library.removeListener('block', blockNumberCallback)\n    }\n  }, [dispatch, chainId, library, blockNumberCallback, windowVisible])\n\n  const debouncedState = useDebounce(state, 100)\n\n  useEffect(() => {\n    if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return\n    if (debouncedState.blockNumber - (blockNumber || 0) < BLOCK_NUMBER_MINIMUM_DIFF) return\n    dispatch(updateBlockNumber({ chainId: debouncedState.chainId, blockNumber: debouncedState.blockNumber }))\n  }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId, blockNumber])\n\n  return null\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}